/*!
 *  opentok-whiteboard (http://github.com/aullman/opentok-whiteboard)
 *  
 *  Shared Whiteboard that works with OpenTok
 *
 *  @Author: Adam Ullman (http://github.com/aullman)
 *  @Copyright (c) 2014 Adam Ullman
 *  @License: Released under the MIT license (http://opensource.org/licenses/MIT)
**/
var OpenTokWhiteboard=angular.module("opentok-whiteboard",["opentok"]).directive("otWhiteboard",["OTSession","$window",function(o){return{restrict:"E",template:'<canvas></canvas><div class="OT_panel"><input type="button" ng-class="{OT_color: true, OT_selected: c[\'background-color\'] === color}" ng-repeat="c in colors" ng-style="c" ng-click="changeColor(c)"></input><input type="button" ng-click="erase()" ng-class="{OT_erase: true, OT_selected: erasing}" value="Eraser"></input><input type="button" ng-click="capture()" class="OT_capture" value="{{captureText}}"></input><input type="button" ng-click="clear()" class="OT_clear" value="Clear"></input>',link:function(e,t,n){var i,c,a=t.context.querySelector("canvas"),r=(t.context.querySelector("select"),t.context.querySelector("input"),{dragging:!1}),s=[],l=[],u=/(iPad|iPhone|iPod)/g.test(navigator.userAgent);e.colors=[{"background-color":"black"},{"background-color":"blue"},{"background-color":"red"},{"background-color":"green"},{"background-color":"orange"},{"background-color":"purple"},{"background-color":"brown"}],e.captureText=u?"Email":"Capture",a.width=n.width||t.width(),a.height=n.height||t.height();var g=function(){i.save(),i.setTransform(1,0,0,1,0,0),i.clearRect(0,0,a.width,a.height),i.restore(),s=[]};e.changeColor=function(o){e.color=o["background-color"],e.lineWidth=2,e.erasing=!1},e.changeColor(e.colors[Math.floor(Math.random()*e.colors.length)]),e.clear=function(){g(),o.session&&o.session.signal({type:"otWhiteboard_clear"})},e.erase=function(){e.color=t.css("background-color")||"#fff",e.lineWidth=50,e.erasing=!0},e.capture=function(){u?window.location.href="mailto:?subject=Whiteboard&Body=<img src='"+a.toDataURL("image/png")+"'>":window.open(a.toDataURL("image/png"))};var d,h=function(o){i||(i=a.getContext("2d"),i.lineCap="round",i.fillStyle="solid"),i.strokeStyle=o.color,i.lineWidth=o.lineWidth,i.beginPath(),i.moveTo(o.fromX,o.fromY),i.lineTo(o.toX,o.toY),i.stroke(),i.closePath(),s.push(o)},p=function(o){o.forEach(function(o){h(o)})},f=function(e,t,n){for(var i=t.slice(),c=function(o){o&&TB.error(o)};i.length;){var a=i.splice(0,Math.min(i.length,32)),r={type:e,data:JSON.stringify(a)};n&&(r.to=n),o.session.signal(r,c)}},m=function(e){o.session&&(l.push(e),d||(d=setTimeout(function(){f("otWhiteboard_update",l),l=[],d=null},100)))};angular.element(a).on("mousedown mousemove mouseup mouseout touchstart touchmove touchend",function(n){if("mousemove"!==n.type||r.dragging){n.preventDefault();var i=angular.element(a).offset(),c=a.width/t.width(),s=a.height/t.height(),l=n.offsetX||n.originalEvent.pageX-i.left||n.originalEvent.touches[0].pageX-i.left,u=n.offsetY||n.originalEvent.pageY-i.top||n.originalEvent.touches[0].pageY-i.top,g=l*c,d=u*s;switch(n.type){case"mousedown":case"touchstart":r.dragging=!0,r.lastX=g,r.lastY=d;break;case"mousemove":case"touchmove":if(r.dragging){var p={id:o.session&&o.session.connection&&o.session.connection.connectionId,fromX:r.lastX,fromY:r.lastY,toX:g,toY:d,color:e.color,lineWidth:e.lineWidth};h(p),r.lastX=g,r.lastY=d,m(p)}break;case"mouseup":case"touchend":case"mouseout":r.dragging=!1}}}),o.session&&o.session.on({"signal:otWhiteboard_update":function(t){t.from.connectionId!==o.session.connection.connectionId&&(p(JSON.parse(t.data)),e.$emit("otWhiteboardUpdate"))},"signal:otWhiteboard_history":function(o){c&&c!==o.from.connectionId||(c=o.from.connectionId,p(JSON.parse(o.data)),e.$emit("otWhiteboardUpdate"))},"signal:otWhiteboard_clear":function(e){e.from.connectionId!==o.session.connection.connectionId&&g()},connectionCreated:function(e){s.length>0&&e.connection.connectionId!==o.session.connection.connectionId&&f("otWhiteboard_history",s,e.connection)}})}}}]);