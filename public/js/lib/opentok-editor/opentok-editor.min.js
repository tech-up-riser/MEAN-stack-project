if("undefined"==typeof ot)var ot={};if(ot.TextOperation=function(){"use strict";function t(){return this&&this.constructor===t?(this.ops=[],this.baseLength=0,void(this.targetLength=0)):new t}function e(e){var o=e.ops,n=t.isRetain;switch(o.length){case 1:return o[0];case 2:return n(o[0])?o[1]:n(o[1])?o[0]:null;case 3:if(n(o[0])&&n(o[2]))return o[1]}return null}function o(t){return n(t.ops[0])?t.ops[0]:0}t.prototype.equals=function(t){if(this.baseLength!==t.baseLength)return!1;if(this.targetLength!==t.targetLength)return!1;if(this.ops.length!==t.ops.length)return!1;for(var e=0;e<this.ops.length;e++)if(this.ops[e]!==t.ops[e])return!1;return!0};var n=t.isRetain=function(t){return"number"==typeof t&&t>0},r=t.isInsert=function(t){return"string"==typeof t},i=t.isDelete=function(t){return"number"==typeof t&&0>t};return t.prototype.retain=function(t){if("number"!=typeof t)throw new Error("retain expects an integer");return 0===t?this:(this.baseLength+=t,this.targetLength+=t,n(this.ops[this.ops.length-1])?this.ops[this.ops.length-1]+=t:this.ops.push(t),this)},t.prototype.insert=function(t){if("string"!=typeof t)throw new Error("insert expects a string");if(""===t)return this;this.targetLength+=t.length;var e=this.ops;return r(e[e.length-1])?e[e.length-1]+=t:i(e[e.length-1])?r(e[e.length-2])?e[e.length-2]+=t:(e[e.length]=e[e.length-1],e[e.length-2]=t):e.push(t),this},t.prototype["delete"]=function(t){if("string"==typeof t&&(t=t.length),"number"!=typeof t)throw new Error("delete expects an integer or a string");return 0===t?this:(t>0&&(t=-t),this.baseLength-=t,i(this.ops[this.ops.length-1])?this.ops[this.ops.length-1]+=t:this.ops.push(t),this)},t.prototype.isNoop=function(){return 0===this.ops.length||1===this.ops.length&&n(this.ops[0])},t.prototype.toString=function(){var t=Array.prototype.map||function(t){for(var e=this,o=[],n=0,r=e.length;r>n;n++)o[n]=t(e[n]);return o};return t.call(this.ops,function(t){return n(t)?"retain "+t:r(t)?"insert '"+t+"'":"delete "+-t}).join(", ")},t.prototype.toJSON=function(){return this.ops},t.fromJSON=function(e){for(var o=new t,s=0,a=e.length;a>s;s++){var p=e[s];if(n(p))o.retain(p);else if(r(p))o.insert(p);else{if(!i(p))throw new Error("unknown operation: "+JSON.stringify(p));o["delete"](p)}}return o},t.prototype.apply=function(t){var e=this;if(t.length!==e.baseLength)throw new Error("The operation's base length must be equal to the string's length.");for(var o=[],i=0,s=0,a=this.ops,p=0,c=a.length;c>p;p++){var u=a[p];if(n(u)){if(s+u>t.length)throw new Error("Operation can't retain more characters than are left in the string.");o[i++]=t.slice(s,s+u),s+=u}else r(u)?o[i++]=u:s-=u}if(s!==t.length)throw new Error("The operation didn't operate on the whole string.");return o.join("")},t.prototype.invert=function(e){for(var o=0,i=new t,s=this.ops,a=0,p=s.length;p>a;a++){var c=s[a];n(c)?(i.retain(c),o+=c):r(c)?i["delete"](c.length):(i.insert(e.slice(o,o-c)),o-=c)}return i},t.prototype.compose=function(e){var o=this;if(o.targetLength!==e.baseLength)throw new Error("The base length of the second operation has to be the target length of the first operation");for(var s=new t,a=o.ops,p=e.ops,c=0,u=0,h=a[c++],f=p[u++];;){if("undefined"==typeof h&&"undefined"==typeof f)break;if(i(h))s["delete"](h),h=a[c++];else if(r(f))s.insert(f),f=p[u++];else{if("undefined"==typeof h)throw new Error("Cannot compose operations: first operation is too short.");if("undefined"==typeof f)throw new Error("Cannot compose operations: first operation is too long.");if(n(h)&&n(f))h>f?(s.retain(f),h-=f,f=p[u++]):h===f?(s.retain(h),h=a[c++],f=p[u++]):(s.retain(h),f-=h,h=a[c++]);else if(r(h)&&i(f))h.length>-f?(h=h.slice(-f),f=p[u++]):h.length===-f?(h=a[c++],f=p[u++]):(f+=h.length,h=a[c++]);else if(r(h)&&n(f))h.length>f?(s.insert(h.slice(0,f)),h=h.slice(f),f=p[u++]):h.length===f?(s.insert(h),h=a[c++],f=p[u++]):(s.insert(h),f-=h.length,h=a[c++]);else{if(!n(h)||!i(f))throw new Error("This shouldn't happen: op1: "+JSON.stringify(h)+", op2: "+JSON.stringify(f));h>-f?(s["delete"](f),h+=f,f=p[u++]):h===-f?(s["delete"](f),h=a[c++],f=p[u++]):(s["delete"](h),f+=h,h=a[c++])}}}return s},t.prototype.shouldBeComposedWith=function(t){if(this.isNoop()||t.isNoop())return!0;var n=o(this),s=o(t),a=e(this),p=e(t);return a&&p?r(a)&&r(p)?n+a.length===s:i(a)&&i(p)?s-p===n||n===s:!1:!1},t.prototype.shouldBeComposedWithInverted=function(t){if(this.isNoop()||t.isNoop())return!0;var n=o(this),s=o(t),a=e(this),p=e(t);return a&&p?r(a)&&r(p)?n+a.length===s||n===s:i(a)&&i(p)?s-p===n:!1:!1},t.transform=function(e,o){if(e.baseLength!==o.baseLength)throw new Error("Both operations have to have the same base length");for(var s=new t,a=new t,p=e.ops,c=o.ops,u=0,h=0,f=p[u++],l=c[h++];;){if("undefined"==typeof f&&"undefined"==typeof l)break;if(r(f))s.insert(f),a.retain(f.length),f=p[u++];else if(r(l))s.retain(l.length),a.insert(l),l=c[h++];else{if("undefined"==typeof f)throw new Error("Cannot compose operations: first operation is too short.");if("undefined"==typeof l)throw new Error("Cannot compose operations: first operation is too long.");var d;if(n(f)&&n(l))f>l?(d=l,f-=l,l=c[h++]):f===l?(d=l,f=p[u++],l=c[h++]):(d=f,l-=f,f=p[u++]),s.retain(d),a.retain(d);else if(i(f)&&i(l))-f>-l?(f-=l,l=c[h++]):f===l?(f=p[u++],l=c[h++]):(l-=f,f=p[u++]);else if(i(f)&&n(l))-f>l?(d=l,f+=l,l=c[h++]):-f===l?(d=l,f=p[u++],l=c[h++]):(d=-f,l+=f,f=p[u++]),s["delete"](d);else{if(!n(f)||!i(l))throw new Error("The two operations aren't compatible");f>-l?(d=-l,f+=l,l=c[h++]):f===-l?(d=f,f=p[u++],l=c[h++]):(d=f,l+=f,f=p[u++]),a["delete"](d)}}}return[s,a]},t}(),"object"==typeof module&&(module.exports=ot.TextOperation),"undefined"==typeof ot)var ot={};if(ot.Cursor=function(t){"use strict";function e(t,e){this.position=t;for(var o=[],n=0;n<e.length;n++)e[n].isEmpty()||o.push(e[n]);this.selection=o}function o(t,e){this.anchor=t,this.head=e}var n=t.ot?t.ot.TextOperation:require("./text-operation");return e.Range=o,o.fromJSON=function(t){return new o(t.anchor,t.head)},o.prototype.equals=function(t){return this.anchor===t.anchor&&this.head===t.head},o.prototype.isEmpty=function(){return this.anchor===this.head},e.fromJSON=function(t){for(var n=[],r=0;r<t.selection.length;r++)n[r]=o.fromJSON(t.selection[r]);return new e(t.position,n)},e.prototype.equals=function(t){if(this.position!==t.position)return!1;if(this.selection.length!==t.selection.length)return!1;for(var e=0;e<this.selection.length;e++)if(!this.selection[e].equals(t.selection[e]))return!1;return!0},e.prototype.compose=function(t){return t},e.prototype.transform=function(t){function r(e){for(var o=e,r=t.ops,i=0,s=t.ops.length;s>i&&(n.isRetain(r[i])?e-=r[i]:n.isInsert(r[i])?o+=r[i].length:(o-=Math.min(e,-r[i]),e+=r[i]),!(0>e));i++);return o}for(var i=r(this.position),s=[],a=0;a<this.selection.length;a++){var p=this.selection[a],c=new o(r(p.anchor),r(p.head));c.isEmpty()||s.push(c)}return new e(i,s)},e}(this),"object"==typeof module&&(module.exports=ot.Cursor),"undefined"==typeof ot)var ot={};if(ot.WrappedOperation=function(){"use strict";function t(t,e){this.wrapped=t,this.meta=e}function e(t,e){for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o])}function o(t,o){if(t&&"object"==typeof t){if("function"==typeof t.compose)return t.compose(o);var n={};return e(t,n),e(o,n),n}return o}function n(t,e){return t&&"object"==typeof t&&"function"==typeof t.transform?t.transform(e):t}return t.prototype.apply=function(){return this.wrapped.apply.apply(this.wrapped,arguments)},t.prototype.invert=function(){var e=this.meta;return new t(this.wrapped.invert.apply(this.wrapped,arguments),e&&"object"==typeof e&&"function"==typeof e.invert?e.invert.apply(e,arguments):e)},t.prototype.compose=function(e){return new t(this.wrapped.compose(e.wrapped),o(this.meta,e.meta))},t.transform=function(e,o){var r=e.wrapped.constructor.transform,i=r(e.wrapped,o.wrapped);return[new t(i[0],n(e.meta,o.wrapped)),new t(i[1],n(o.meta,e.wrapped))]},t}(this),"object"==typeof module&&(module.exports=ot.WrappedOperation),"undefined"==typeof ot)var ot={};if(ot.UndoManager=function(){"use strict";function t(t){this.maxItems=t||50,this.state=o,this.dontCompose=!1,this.undoStack=[],this.redoStack=[]}function e(t,e){for(var o=[],n=e.constructor,r=t.length-1;r>=0;r--){var i=n.transform(t[r],e);"function"==typeof i[0].isNoop&&i[0].isNoop()||o.push(i[0]),e=i[1]}return o.reverse()}var o="normal",n="undoing",r="redoing";return t.prototype.add=function(t,e){if(this.state===n)this.redoStack.push(t),this.dontCompose=!0;else if(this.state===r)this.undoStack.push(t),this.dontCompose=!0;else{var o=this.undoStack;!this.dontCompose&&e&&o.length>0?o.push(t.compose(o.pop())):(o.push(t),o.length>this.maxItems&&o.shift()),this.dontCompose=!1,this.redoStack=[]}},t.prototype.transform=function(t){this.undoStack=e(this.undoStack,t),this.redoStack=e(this.redoStack,t)},t.prototype.performUndo=function(t){if(this.state=n,0===this.undoStack.length)throw new Error("undo not possible");t(this.undoStack.pop()),this.state=o},t.prototype.performRedo=function(t){if(this.state=r,0===this.redoStack.length)throw new Error("redo not possible");t(this.redoStack.pop()),this.state=o},t.prototype.canUndo=function(){return 0!==this.undoStack.length},t.prototype.canRedo=function(){return 0!==this.redoStack.length},t.prototype.isUndoing=function(){return this.state===n},t.prototype.isRedoing=function(){return this.state===r},t}(),"object"==typeof module&&(module.exports=ot.UndoManager),"undefined"==typeof ot)var ot={};if(ot.Client=function(){"use strict";function t(t){this.revision=t,this.state=r}function e(){}function o(t){this.outstanding=t}function n(t,e){this.outstanding=t,this.buffer=e}t.prototype.setState=function(t){this.state=t},t.prototype.applyClient=function(t){this.setState(this.state.applyClient(this,t))},t.prototype.applyServer=function(t){this.revision++,this.setState(this.state.applyServer(this,t))},t.prototype.serverAck=function(){this.revision++,this.setState(this.state.serverAck(this))},t.prototype.serverReconnect=function(){"function"==typeof this.state.resend&&this.state.resend(this)},t.prototype.transformCursor=function(t){return this.state.transformCursor(t)},t.prototype.sendOperation=function(){throw new Error("sendOperation must be defined in child class")},t.prototype.applyOperation=function(){throw new Error("applyOperation must be defined in child class")},t.Synchronized=e,e.prototype.applyClient=function(t,e){return t.sendOperation(t.revision,e),new o(e)},e.prototype.applyServer=function(t,e){return t.applyOperation(e),this},e.prototype.serverAck=function(){throw new Error("There is no pending operation.")},e.prototype.transformCursor=function(t){return t};var r=new e;return t.AwaitingConfirm=o,o.prototype.applyClient=function(t,e){return new n(this.outstanding,e)},o.prototype.applyServer=function(t,e){var n=e.constructor.transform(this.outstanding,e);return t.applyOperation(n[1]),new o(n[0])},o.prototype.serverAck=function(){return r},o.prototype.transformCursor=function(t){return t.transform(this.outstanding)},o.prototype.resend=function(t){t.sendOperation(t.revision,this.outstanding)},t.AwaitingWithBuffer=n,n.prototype.applyClient=function(t,e){var o=this.buffer.compose(e);return new n(this.outstanding,o)},n.prototype.applyServer=function(t,e){var o=e.constructor.transform,r=o(this.outstanding,e),i=o(this.buffer,r[1]);return t.applyOperation(i[1]),new n(r[0],i[0])},n.prototype.serverAck=function(t){return t.sendOperation(t.revision,this.buffer),new o(this.buffer)},n.prototype.transformCursor=function(t){return t.transform(this.outstanding).transform(this.buffer)},n.prototype.resend=function(t){t.sendOperation(t.revision,this.outstanding)},t}(this),"object"==typeof module&&(module.exports=ot.Client),ot.CodeMirrorAdapter=function(t){"use strict";function e(e){this.cm=e,this.ignoreNextChange=!1,a(this,"onChange"),a(this,"onCursorActivity"),a(this,"onFocus"),a(this,"onBlur"),t.CodeMirror&&/^4\./.test(t.CodeMirror.version)?e.on("changes",this.onChange):e.on("change",this.onChange),e.on("cursorActivity",this.onCursorActivity),e.on("focus",this.onFocus),e.on("blur",this.onBlur)}function o(t,e){return t.line<e.line?-1:t.line>e.line?1:t.ch<e.ch?-1:t.ch>e.ch?1:0}function n(t,e){return o(t,e)<=0}function r(t,e){return n(t,e)?t:e}function i(t,e){return n(t,e)?e:t}function s(t){return t.indexFromPos({line:t.lastLine(),ch:0})+t.getLine(t.lastLine()).length}function a(t,e){var o=t[e];t[e]=function(){o.apply(t,arguments)}}var p=ot.TextOperation,c=ot.Cursor;e.prototype.detach=function(){this.cm.off("changes",this.onChange),this.cm.off("change",this.onChange),this.cm.off("cursorActivity",this.onCursorActivity),this.cm.off("focus",this.onFocus),this.cm.off("blur",this.onBlur)},e.operationFromCodeMirrorChanges=function(t,e){function o(t){return t[t.length-1]}function r(t){if(0===t.length)return 0;for(var e=0,o=0;o<t.length;o++)e+=t[o].length;return e+t.length-1}function i(t,e){return function(i){return n(i,e.from)?t(i):n(e.to,i)?t({line:i.line+e.text.length-1-(e.to.line-e.from.line),ch:e.to.line<i.line?i.ch:e.text.length<=1?i.ch-(e.to.ch-e.from.ch)+r(e.text):i.ch-e.to.ch+o(e.text).length})+r(e.removed)-r(e.text):e.from.line===i.line?t(e.from)+i.ch-e.from.ch:t(e.from)+r(e.removed.slice(0,i.line-e.from.line))+1+i.ch}}var a,c=0;if("object"==typeof t.from){for(a=[];t;)a[c++]=t,t=t.next;t=a}var u=s(e),h=(new p).retain(u),f=(new p).retain(u),l=function(t){return e.indexFromPos(t)};for(c=t.length-1;c>=0;c--){var d=t[c];l=i(l,d);var g=l(d.from),m=u-g-r(d.text);h=(new p).retain(g)["delete"](r(d.removed)).insert(d.text.join("\n")).retain(m).compose(h),f=f.compose((new p).retain(g)["delete"](r(d.text)).insert(d.removed.join("\n")).retain(m)),u+=r(d.removed)-r(d.text)}return[h,f]},e.operationFromCodeMirrorChange=e.operationFromCodeMirrorChanges,e.applyOperationToCodeMirror=function(t,e){e.operation(function(){for(var o=t.ops,n=0,r=0,i=o.length;i>r;r++){var s=o[r];if(p.isRetain(s))n+=s;else if(p.isInsert(s))e.replaceRange(s,e.posFromIndex(n)),n+=s.length;else if(p.isDelete(s)){var a=e.posFromIndex(n),c=e.posFromIndex(n-s);e.replaceRange("",a,c)}}})},e.prototype.registerCallbacks=function(t){this.callbacks=t},e.prototype.onChange=function(t,o){if(!this.ignoreNextChange){var n=e.operationFromCodeMirrorChanges(o,this.cm);this.trigger("change",n[0],n[1])}this.ignoreNextChange=!1},e.prototype.onCursorActivity=e.prototype.onFocus=function(){this.trigger("cursorActivity")},e.prototype.onBlur=function(){this.cm.somethingSelected()||this.trigger("blur")},e.prototype.getValue=function(){return this.cm.getValue()},e.prototype.getCursor=function(){for(var t=this.cm,e=t.getCursor(),o=t.indexFromPos(e),n=t.listSelections(),r=[],i=0;i<n.length;i++)r[i]=new c.Range(t.indexFromPos(n[i].anchor),t.indexFromPos(n[i].head));return new c(o,r)},e.prototype.setCursor=function(t){var e=this.cm.posFromIndex(t.position);if(0===t.selection.length)this.cm.setCursor(e);else{for(var o=null,n=[],r=0;r<t.selection.length;r++){var i=t.selection[r];i.head===e&&(o=r),n[r]={anchor:i.anchor,head:i.head}}this.cm.setSelections(n,o)}};var u=function(){var t={},e=document.createElement("style");document.documentElement.getElementsByTagName("head")[0].appendChild(e);var o=e.sheet;return function(e){t[e]||(t[e]=!0,o.insertRule(e,(o.cssRules||o.rules).length))}}();return e.prototype.setOtherCursor=function(t,e,o){var n=this.cm.posFromIndex(t.position);if(0===t.selection.length){var s=this.cm.cursorCoords(n),a=document.createElement("pre");return a.className="other-client",a.style.borderLeftWidth="2px",a.style.borderLeftStyle="solid",a.innerHTML="&nbsp;",a.style.borderLeftColor=e,a.style.height=.9*(s.bottom-s.top)+"px",a.style.marginTop=s.top-s.bottom+"px",a.style.zIndex=0,a.setAttribute("data-clientid",o),this.cm.addWidget(n,a,!1),{clear:function(){var t=a.parentNode;t&&t.removeChild(a)}}}var p=/^#([0-9a-fA-F]{6})$/.exec(e);if(!p)throw new Error("only six-digit hex colors are allowed.");var c="selection-"+p[1],h="."+c+" { background: "+e+"; }";u(h);for(var f=[],l=0;l<t.selection.length;l++){var d=this.cm.posFromIndex(t.selection[l].anchor),g=this.cm.posFromIndex(t.selection[l].head);f[l]=this.cm.markText(r(d,g),i(d,g),{className:c})}return{clear:function(){for(var t=0;t<f.length;t++)f[t].clear()}}},e.prototype.trigger=function(t){var e=Array.prototype.slice.call(arguments,1),o=this.callbacks&&this.callbacks[t];o&&o.apply(this,e)},e.prototype.applyOperation=function(t){this.ignoreNextChange=!0,e.applyOperationToCodeMirror(t,this.cm)},e.prototype.registerUndo=function(t){this.cm.undo=t},e.prototype.registerRedo=function(t){this.cm.redo=t},e}(this),ot.SocketIOAdapter=function(){"use strict";function t(t){this.socket=t;var e=this;t.on("client_left",function(t){e.trigger("client_left",t)}).on("set_name",function(t,o){e.trigger("set_name",t,o)}).on("ack",function(){e.trigger("ack")}).on("operation",function(t,o,n){e.trigger("operation",o),e.trigger("cursor",t,n)}).on("cursor",function(t,o){e.trigger("cursor",t,o)}).on("reconnect",function(){e.trigger("reconnect")})}return t.prototype.sendOperation=function(t,e,o){this.socket.emit("operation",t,e,o)},t.prototype.sendCursor=function(t){this.socket.emit("cursor",t)},t.prototype.registerCallbacks=function(t){this.callbacks=t},t.prototype.trigger=function(t){var e=Array.prototype.slice.call(arguments,1),o=this.callbacks&&this.callbacks[t];o&&o.apply(this,e)},t}(),ot.AjaxAdapter=function(){"use strict";function t(t,e,o){"/"!==t[t.length-1]&&(t+="/"),this.path=t,this.ownUserName=e,this.majorRevision=o.major||0,this.minorRevision=o.minor||0,this.poll()}return t.prototype.renderRevisionPath=function(){return"revision/"+this.majorRevision+"-"+this.minorRevision},t.prototype.handleResponse=function(t){var e,o=t.operations;for(e=0;e<o.length;e++)o[e].user===this.ownUserName?this.trigger("ack"):this.trigger("operation",o[e].operation);o.length>0&&(this.majorRevision+=o.length,this.minorRevision=0);var n=t.events;if(n){for(e=0;e<n.length;e++){var r=n[e].user;if(r!==this.ownUserName)switch(n[e].event){case"joined":this.trigger("set_name",r,r);break;case"left":this.trigger("client_left",r);break;case"cursor":this.trigger("cursor",r,n[e].cursor)}}this.minorRevision+=n.length}var i=t.users;i&&(delete i[this.ownUserName],this.trigger("clients",i)),t.revision&&(this.majorRevision=t.revision.major,this.minorRevision=t.revision.minor)},t.prototype.poll=function(){var t=this;$.ajax({url:this.path+this.renderRevisionPath(),type:"GET",dataType:"json",timeout:5e3,success:function(e){t.handleResponse(e),t.poll()},error:function(){setTimeout(function(){t.poll()},500)}})},t.prototype.sendOperation=function(t,e,o){if(t!==this.majorRevision)throw new Error("Revision numbers out of sync");var n=this;$.ajax({url:this.path+this.renderRevisionPath(),type:"POST",data:JSON.stringify({operation:e,cursor:o}),contentType:"application/json",processData:!1,success:function(){},error:function(){setTimeout(function(){n.sendOperation(t,e,o)},500)}})},t.prototype.sendCursor=function(t){$.ajax({url:this.path+this.renderRevisionPath()+"/cursor",type:"POST",data:JSON.stringify(t),contentType:"application/json",processData:!1,timeout:1e3})},t.prototype.registerCallbacks=function(t){this.callbacks=t},t.prototype.trigger=function(t){var e=Array.prototype.slice.call(arguments,1),o=this.callbacks&&this.callbacks[t];o&&o.apply(this,e)},t}(),ot.EditorClient=function(){"use strict";function t(t,e){this.cursorBefore=t,this.cursorAfter=e}function e(t,e){this.clientId=t,this.cursor=e}function o(t,e,o,n,r){this.id=t,this.listEl=e,this.editorAdapter=o,this.name=n,this.li=document.createElement("li"),n&&(this.li.textContent=n,this.listEl.appendChild(this.li)),this.setColor(n?s(n):Math.random()),r&&this.updateCursor(r)}function n(t,e,o,n){u.call(this,t),this.serverAdapter=o,this.editorAdapter=n,this.undoManager=new f,this.initializeClientList(),this.initializeClients(e);var r=this;this.editorAdapter.registerCallbacks({change:function(t,e){r.onChange(t,e)},cursorActivity:function(){r.onCursorActivity()},blur:function(){r.onBlur()}}),this.editorAdapter.registerUndo(function(){r.undo()}),this.editorAdapter.registerRedo(function(){r.redo()}),this.serverAdapter.registerCallbacks({client_left:function(t){r.onClientLeft(t)},set_name:function(t,e){r.getClientObject(t).setName(e)},ack:function(){r.serverAck()},operation:function(t){r.applyServer(l.fromJSON(t))},cursor:function(t,e){e?r.getClientObject(t).updateCursor(r.transformCursor(h.fromJSON(e))):r.getClientObject(t).removeCursor()},clients:function(t){var e;for(e in r.clients)r.clients.hasOwnProperty(e)&&!t.hasOwnProperty(e)&&r.onClientLeft(e);for(e in t)if(t.hasOwnProperty(e)&&r.clients.hasOwnProperty(e)){var o=t[e];o?r.clients[e].updateCursor(r.transformCursor(h.fromJSON(o))):r.clients[e].removeCursor()}},reconnect:function(){r.serverReconnect()}})}function r(t,e,o){function n(t){var e=Math.round(255*t).toString(16);return 1===e.length?"0"+e:e}return"#"+n(t)+n(e)+n(o)}function i(t,e,o){if(0===e)return r(o,o,o);var n=.5>o?o*(1+e):o+e-e*o,i=2*o-n,s=function(t){return 0>t&&(t+=1),t>1&&(t-=1),1>6*t?i+6*(n-i)*t:1>2*t?n:2>3*t?i+6*(n-i)*(2/3-t):i};return r(s(t+1/3),s(t),s(t-1/3))}function s(t){for(var e=1,o=0;o<t.length;o++)e=17*(e+t.charCodeAt(o))%360;return e/360}function a(t,e){function o(){}o.prototype=e.prototype,t.prototype=new o,t.prototype.constructor=t}function p(t){return t[t.length-1]}function c(t){t.parentNode&&t.parentNode.removeChild(t)}var u=ot.Client,h=ot.Cursor,f=ot.UndoManager,l=ot.TextOperation,d=ot.WrappedOperation;return t.prototype.invert=function(){return new t(this.cursorAfter,this.cursorBefore)},t.prototype.compose=function(e){return new t(this.cursorBefore,e.cursorAfter)},t.prototype.transform=function(e){return new t(this.cursorBefore.transform(e),this.cursorAfter.transform(e))},e.fromJSON=function(t){return new e(t.clientId,t.cursor&&h.fromJSON(t.cursor))},e.prototype.transform=function(t){return new e(this.clientId,this.cursor&&this.cursor.transform(t))},o.prototype.setColor=function(t){this.hue=t,this.color=i(t,.75,.5),this.lightColor=i(t,.5,.9),this.li&&(this.li.style.color=this.color)},o.prototype.setName=function(t){this.name=t,this.li.textContent=t,this.li.parentNode||this.listEl.appendChild(this.li),this.setColor(s(t))},o.prototype.updateCursor=function(t){this.removeCursor(),this.cursor=t,this.mark=this.editorAdapter.setOtherCursor(t,t.position===t.selectionEnd?this.color:this.lightColor,this.id)},o.prototype.remove=function(){this.li&&c(this.li),this.removeCursor()},o.prototype.removeCursor=function(){this.mark&&this.mark.clear()},a(n,u),n.prototype.addClient=function(t,e){this.clients[t]=new o(t,this.clientListEl,this.editorAdapter,e.name||t,e.cursor?h.fromJSON(e.cursor):null)},n.prototype.initializeClients=function(t){this.clients={};for(var e in t)t.hasOwnProperty(e)&&this.addClient(e,t[e])},n.prototype.getClientObject=function(t){var e=this.clients[t];return e?e:this.clients[t]=new o(t,this.clientListEl,this.editorAdapter)},n.prototype.onClientLeft=function(t){console.log("User disconnected: "+t);var e=this.clients[t];e&&(e.remove(),delete this.clients[t])},n.prototype.initializeClientList=function(){this.clientListEl=document.createElement("ul")},n.prototype.applyUnredo=function(t){this.undoManager.add(t.invert(this.editorAdapter.getValue())),this.editorAdapter.applyOperation(t.wrapped),this.cursor=t.meta.cursorAfter,this.editorAdapter.setCursor(this.cursor),this.applyClient(t.wrapped)},n.prototype.undo=function(){var t=this;this.undoManager.canUndo()&&this.undoManager.performUndo(function(e){t.applyUnredo(e)})},n.prototype.redo=function(){var t=this;this.undoManager.canRedo()&&this.undoManager.performRedo(function(e){t.applyUnredo(e)})},n.prototype.onChange=function(e,o){var n=this.cursor;this.updateCursor();var r=new t(n,this.cursor),i=(new d(e,r),this.undoManager.undoStack.length>0&&o.shouldBeComposedWithInverted(p(this.undoManager.undoStack).wrapped)),s=new t(this.cursor,n);this.undoManager.add(new d(o,s),i),this.applyClient(e)},n.prototype.updateCursor=function(){this.cursor=this.editorAdapter.getCursor()},n.prototype.onCursorActivity=function(){var t=this.cursor;this.updateCursor(),t&&this.cursor.equals(t)||this.sendCursor(this.cursor)},n.prototype.onBlur=function(){this.cursor=null,this.sendCursor(null)},n.prototype.sendCursor=function(t){this.state instanceof u.AwaitingWithBuffer||this.serverAdapter.sendCursor(t)},n.prototype.sendOperation=function(t,e){this.serverAdapter.sendOperation(t,e.toJSON(),this.cursor)},n.prototype.applyOperation=function(t){this.editorAdapter.applyOperation(t),this.updateCursor(),this.undoManager.transform(new d(t,null))},n}(),"undefined"==typeof ot)var ot={};ot.Server=function(){"use strict";function t(t,e){this.document=t,this.operations=e||[]}return t.prototype.receiveOperation=function(t,e){if(0>t||this.operations.length<t)throw new Error("operation revision not in history");for(var o=this.operations.slice(t),n=e.constructor.transform,r=0;r<o.length;r++)e=n(e,o[r])[0];return this.document=e.apply(this.document),this.operations.push(e),e},t}(this),"object"==typeof module&&(module.exports=ot.Server);var OpenTokAdapter=function(){"use strict";function t(t,e,o,n){if(OT.$.eventing(this),this.registerCallbacks=this.on,this.session=t,n&&e>n.length){var r=[];r[e-n.length-1]=null,this.operations=r.concat(n)}else this.operations=n?n:[];var i=new ot.Server(o,this.operations);this.session.on({connectionDestroyed:function(t){this.trigger("client_left",t.connection.connectionId)},connectionCreated:function(t){t.connection.data&&t.connection.data.name&&this.trigger("set_name",t.connection.connectionId,t.connection.data.name)},"signal:opentok-editor-operation":function(e){var o,n=JSON.parse(e.data);o=new ot.WrappedOperation(ot.TextOperation.fromJSON(n.operation),n.cursor&&ot.Cursor.fromJSON(n.cursor));var r=i.receiveOperation(n.revision,o);console.log("new operation: "+o),e.from.connectionId===t.connection.connectionId?this.trigger("ack"):(this.trigger("operation",r.wrapped.toJSON()),this.trigger("cursor",e.from.connectionId,r.meta))},"signal:opentok-editor-cursor":function(t){var e=JSON.parse(t.data);this.trigger("cursor",t.from.connectionId,e)}},this)}return t.prototype.sendOperation=function(t,e,o){this.session.signal({type:"opentok-editor-operation",data:JSON.stringify({revision:t,operation:e,cursor:o})},function(t){t&&console.error("Error sending operation",t)}.bind(this))},t.prototype.sendCursor=function(t){this.session.signal({type:"opentok-editor-cursor",data:JSON.stringify(t)})},t}();!function(){var t=function(t){return t.map(function(t){return{operation:t.wrapped.toJSON()}})},e=function(t){return t.map(function(t){return new ot.WrappedOperation(ot.TextOperation.fromJSON(t.operation),t.cursor&&ot.Cursor.fromJSON(t.cursor))})};angular.module("opentok-editor",["opentok"]).directive("otEditor",["OTSession","$window",function(o){return{restrict:"E",scope:{modes:"="},template:'<div class="opentok-editor-mode-select" ng-show="!connecting"><select ng-model="selectedMode" name="modes" ng-options="mode.name for mode in modes"></select></div><div ng-if="connecting" class="opentok-editor-connecting">Connecting...</div><div ng-show="!connecting"><div class="opentok-editor"></div></div>',link:function(n,r,i){var s,a,p,c,u=r.context.querySelector("div.opentok-editor"),h=(r.context.querySelector("select"),!1),f=o.session;n.connecting=!0;var l=n.modes.filter(function(t){return t.value===i.mode});n.selectedMode=l.length>0?l[0]:n.modes[0];var d=function(t,e,o,r){a||(c=new OpenTokAdapter(f,t,o,r),c.registerCallbacks("operation",function(){n.$emit("otEditorUpdate")}),a=new ot.EditorClient(t,e,c,new ot.CodeMirrorAdapter(s)),n.$apply(function(){n.connecting=!1,setTimeout(function(){s.refresh()},1e3)}))},g=function(){s&&!h&&(h=!0,s.getValue()!==p.str&&(s.setValue(p.str),n.$emit("otEditorUpdate")),d(p.revision,p.clients,p.str,e(p.operations)))},m=function(e){var o=c&&c.operations?t(c.operations):[];o.length>50&&(o=o.slice(o.length-50));var n={type:"opentok-editor-doc",data:JSON.stringify({revision:a.revision,clients:[],str:s.getValue(),operations:o})};e&&(n.to=e),f.signal(n)},y=function(){s=CodeMirror(u,i),f.signal({type:"opentok-editor-request-doc"}),setTimeout(function(){h||(h=!0,d(0,[],s.getValue()),m())},1e4)};f.on({sessionConnected:function(){y()},"signal:opentok-editor-request-doc":function(t){a&&t.from.connectionId!==f.connection.connectionId&&m(t.from)},"signal:opentok-editor-doc":function(t){p=JSON.parse(t.data),g()}}),f.isConnected()&&y(),n.$watch("selectedMode",function(){s&&s.setOption("mode",n.selectedMode.value)}),n.$on("otEditorRefresh",function(){s.refresh()})}}}])}();